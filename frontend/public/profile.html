<!DOCTYPE html>
<html lang="en">
        <!-- Theme script MUST be first -->
  <script>
  (function() {
    const theme = localStorage.getItem('naco_theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    window.addEventListener('DOMContentLoaded', () => {
      document.body.className = theme;
    });
  })();
</script>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - Naco</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Modern CSS Variables */
    :root {
      /* Dark Mode as default - Normal Black Theme */
      --golden: #c9b037;
      --green: #0f7a4a;
      --green-light: #10955a;
      --green-dark: #0d5a38;
      --accent: linear-gradient(135deg, #0f7a4a 0%, #c9b037 100%);
      --bg: #000000; /* Pure black background */
      --card: #1a1a1a; /* Dark gray for cards */
      --text: #ffffff; /* Pure white text */
      --muted: #888888; /* Medium gray for muted text */
      --border: #333333; /* Dark gray borders */
      --border-light: #444444; /* Slightly lighter borders */
      --radius: 16px;
      --radius-sm: 8px;
      --radius-lg: 24px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3),
                0 2px 4px -2px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.3),
                   0 8px 10px -6px rgb(0 0 0 / 0.3);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Light Mode Variables */
    body.light {
      --bg: #f8faf9;
      --card: #ffffff;
      --text: #000000; /* Black text for light mode */
      --muted: #666666; /* Dark gray for muted text */
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
                0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1),
                   0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    /* Completely hide scrollbars across all browsers while maintaining scroll functionality */
    html, body, div, section, main, .scroll-container {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }

    /* WebKit browsers */
    html::-webkit-scrollbar, 
    body::-webkit-scrollbar, 
    div::-webkit-scrollbar, 
    section::-webkit-scrollbar,
    main::-webkit-scrollbar,
    .scroll-container::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
      background: transparent;
    }

    /* Additional hack for browsers like DuckDuckGo */
    body {
      overflow: -moz-scrollbars-none; /* Older Firefox */
    }

    /* For specific containers with scrolling */
    .scroll-container {
      overflow: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    /* Reset and Base */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* HTML and Body Setup */
    html, body, #app {
      height: 100%;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: var(--transition-slow);
    }

    body, html {
      margin: 0;
      padding: 0;
    }

    /* =============================================================================
       PROFILE PAGE STYLES
       ============================================================================= */
    .profile-page {
      min-height: 100vh;
      background: var(--bg);
      padding-bottom: 60px;
    }

    /* Header */
    .profile-header {
      position: sticky;
      top: 0;
      background: var(--card);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .profile-header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      flex: 1;
      text-align: center;
      color: var(--text);
    }

    .back-button,
    .edit-button {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-button:hover,
    .edit-button:hover {
      background: var(--border);
    }

    /* Profile Content */
    .profile-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Avatar Section */
    .profile-avatar-section {
      text-align: center;
      padding: 30px 20px;
      background: var(--card);
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--green);
      margin-bottom: 16px;
      box-shadow: var(--shadow-lg);
    }

    .profile-identity h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: var(--text);
    }

    .profile-role {
      display: inline-block;
      background: var(--green);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin: 8px 0;
    }

    .profile-location {
      color: var(--muted);
      font-size: 14px;
      margin-top: 8px;
    }

    /* Stats Section */
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding: 20px;
      background: var(--card);
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    } 
    
    .profile-image-upload {
  text-align: center;
  margin-bottom: 20px;
}

.upload-label {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.profile-preview {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary-color);
}

.upload-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  color: white;
}

.upload-label:hover .upload-overlay {
  opacity: 1;
}

.upload-overlay i {
  font-size: 24px;
  margin-bottom: 5px;
}

    .stat-item {
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-sm);
      background: var(--bg);
      border: 1px solid var(--border);
    }

    .stat-number {
      display: block;
      font-size: 28px;
      font-weight: 700;
      color: var(--green);
      margin-bottom: 4px;
    }

    .stat-label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Info Section */
    .profile-info {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .info-section {
      margin-bottom: 24px;
    }

    .info-section:last-child {
      margin-bottom: 0;
    }

    .info-section h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text);
      padding-bottom: 8px;
      border-bottom: 2px solid var(--green);
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-item i {
      color: var(--green);
      width: 20px;
      text-align: center;
    }

    .info-item span {
      color: var(--text);
      flex: 1;
    }

    .info-section p {
      color: var(--text);
      line-height: 1.6;
      margin: 0;
    }

    /* Specialties */
    .specialties-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .specialty-tag {
      display: inline-block;
      background: var(--green);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
    }

    /* Menu Section */
    .profile-menu {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      color: inherit;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background: var(--border);
    }

    .menu-item i:first-child {
      width: 40px;
      font-size: 18px;
      color: var(--muted);
    }

    .menu-item span {
      flex: 1;
      font-size: 15px;
    }

    .menu-item i:last-child {
      color: var(--muted);
    }

    /* Role Toggle */
    .toggle-container {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .toggle-container input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border);
      transition: var(--transition);
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: var(--transition);
      border-radius: 50%;
      box-shadow: var(--shadow);
    }

    input:checked + .toggle-slider {
      background: var(--green);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Actions */
    .profile-actions {
      padding: 20px;
    }

    .btn-danger {
      width: 100%;
      padding: 14px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    /* =============================================================================
       EDIT MODAL STYLES
       ============================================================================= */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--card);
      z-index: 10;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      color: var(--text);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--muted);
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--border);
    }

    /* Form Styles */
    .profile-form {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px;
      color: var(--text);
      background: var(--bg);
      transition: var(--transition);
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--green);
      background: var(--card);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Profile Picture Upload */
    .profile-pic-group {
      text-align: center;
      margin-bottom: 30px;
    }

    .pic-upload-container {
      display: inline-block;
      position: relative;
    }

    .pic-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--border);
      display: block;
      margin: 0 auto 12px;
    }

    .upload-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--green);
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }

    .upload-label:hover {
      background: var(--green-light);
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      gap: 12px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      margin-top: 20px;
    }

    .form-actions button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--green);
      color: white;
    }

    .btn-primary:hover {
      background: var(--green-light);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--border-light);
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      min-width: 250px;
      text-align: center;
      animation: slideIn 0.3s ease;
      border: 1px solid var(--border);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translate(-50%, 20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .toast-success {
      border-left: 4px solid var(--green);
    }

    .toast-error {
      border-left: 4px solid #dc2626;
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 60px 20px;
    }

    .error-state i {
      font-size: 64px;
      color: #dc2626;
      margin-bottom: 20px;
    }

    .error-state p {
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 16px;
    }

    .error-state button {
      padding: 12px 24px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* =============================================================================
       RESPONSIVE DESIGN
       ============================================================================= */
    @media (max-width: 768px) {
      .profile-content {
        padding: 16px;
      }

      .profile-stats {
        gap: 12px;
        padding: 16px;
      }

      .stat-item {
        padding: 12px;
      }

      .stat-number {
        font-size: 24px;
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions button {
        width: 100%;
      }
    }
  </style>

</head>
<body>
  <div class="profile-page">
    <!-- Header -->
    <header class="profile-header">
      <button id="back-btn" class="back-button">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1>My Profile</h1>
      <button id="edit-profile-btn" class="edit-button">
        <i class="fas fa-edit"></i>
      </button>
    </header>

    <!-- Profile Content -->
    <div class="profile-content">
      <div class="profile-avatar-section">
        <img id="profile-avatar" src="../assets/avatar-placeholder.png" alt="Profile" class="profile-avatar-large">
        <div class="profile-identity">
          <h2 id="profile-name">Loading...</h2>
          <p id="profile-role" class="profile-role"></p>
          <p id="profile-location" class="profile-location"></p>
        </div>
      </div>

      <div class="profile-stats" id="profile-stats"></div>
      
      <div class="profile-menu" id="profile-menu"></div>

      <div class="profile-info" id="profile-info"></div>

      

      <div class="profile-actions" id="profile-actions"></div>
      <button id="logout-btn" class="btn-danger">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="edit-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="edit-profile-form" class="profile-form"></form>
    </div>
     </div>
     
     <script type="module">
  import themeManager from './js/theme.js';
  // Theme is already applied by the manager
  console.log('Current theme:', themeManager.getCurrentTheme());
</script>
  
  <script type="module" src="js/api.js"></script>
  <script type="module" src="js/utils.js"></script>
  <script type="module" src="js/shared-header.js"></script>

<script type="module">
  import * as API from './js/api.js';
  
  import themeManager from './js/theme.js';

  class ProfilePage {
    constructor() {
      this.user = null;
      this.themeManager = themeManager;
      this.init();
    }

    async init() {
      try {
        // Load current user from localStorage
        this.user = this.getCurrentUser();
        
        if (!this.user) {
          console.log('No user found, redirecting to auth');
          sessionStorage.setItem('returnTo', window.location.href);
          window.location.href = 'auth.html';
          return;
        }

        console.log('User loaded:', this.user);
        this.renderProfile();
        this.bindEvents();
      } catch (error) {
        console.error('Profile initialization failed:', error);
        this.showError('Failed to load profile');
      }
    }

    getCurrentUser() {
      const userData = localStorage.getItem('userData');
      const token = localStorage.getItem('authToken');
      
      if (!token || !userData) {
        return null;
      }
      
      try {
        return JSON.parse(userData);
      } catch (error) {
        console.error('Failed to parse user data:', error);
        return null;
      }
    }

    async renderProfile() {
      // Set avatar
      const avatarUrl = this.getAvatarUrl(this.user);
      document.getElementById('profile-avatar').src = avatarUrl;
      
      // Set basic info
      document.getElementById('profile-name').textContent = this.user.name || 'User';
      document.getElementById('profile-role').textContent = 
        this.user.role === 'artisan' ? 'Artisan' : 'Client';
      document.getElementById('profile-location').textContent = 
        this.user.location ? `ðŸ“ ${this.user.location}` : '';

      // Render stats
      await this.renderStats();

      // Render detailed info
      this.renderDetailedInfo();

      // Render menu
      this.renderMenu();

      // Render action buttons
      this.renderActions();
    }

    getAvatarUrl(user) {
      if (!user) return '../assets/avatar-placeholder.png';
      
      if (user.avatar) {
        if (user.avatar.startsWith('http')) {
          return user.avatar;
        }
        const baseUrl = window.location.hostname === 'localhost' 
          ? 'http://localhost:8091'
          : 'https://naco.onrender.com';
        return `${baseUrl}/uploads/avatars/${user.avatar}`;
      }
      
      return '../assets/avatar-placeholder.png';
    }

    async renderStats() {
      try {
        const bookings = await API.getUserBookings();
        const favorites = await API.getUserFavorites();

        const stats = {
          bookings: bookings.length,
          completed: bookings.filter(b => b.status === 'completed').length,
          favorites: favorites.length
        };

        document.getElementById('profile-stats').innerHTML = `
          <div class="stat-item">
            <span class="stat-number">${stats.bookings}</span>
            <span class="stat-label">${this.user.role === 'artisan' ? 'Jobs' : 'Bookings'}</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">${stats.completed}</span>
            <span class="stat-label">Completed</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">${stats.favorites}</span>
            <span class="stat-label">Favorites</span>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load stats:', error);
        // Show stats with 0 values on error
        document.getElementById('profile-stats').innerHTML = `
          <div class="stat-item">
            <span class="stat-number">0</span>
            <span class="stat-label">${this.user.role === 'artisan' ? 'Jobs' : 'Bookings'}</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">0</span>
            <span class="stat-label">Completed</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">0</span>
            <span class="stat-label">Favorites</span>
          </div>
        `;
      }
    }

    formatCurrency(amount) {
    return new Intl.NumberFormat('en-NG', {
      style: 'currency',
      currency: 'NGN',
      minimumFractionDigits: 0
    }).format(amount);
  }
  
  
    renderDetailedInfo() {
      const infoHtml = `
        <div class="info-section">
          <h3>Contact Information</h3>
          <div class="info-item">
            <i class="fas fa-envelope"></i>
            <span>${this.user.email || 'Not provided'}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-phone"></i>
            <span>${this.user.phone || 'Not provided'}</span>
          </div>
        </div>

        ${this.user.role === 'artisan' ? `
          <div class="info-section">
            <h3>Professional Details</h3>
            <div class="info-item">
              <i class="fas fa-wrench"></i>
              <span>${this.user.skill || 'Not specified'}</span>
            </div>
            <div class="info-item">
              <i class="fas fa-clock"></i>
              <span>${this.user.years_experience || 0} years experience</span>
            </div>
            <div class="info-item">
              <i class="fas fa-money-bill"></i>
              <span>â‚¦${(this.user.rate || 10000).toLocaleString()} per service</span>
            </div>
          </div>

          ${this.user.about ? `
            <div class="info-section">
              <h3>About</h3>
              <p>${this.escapeHtml(this.user.about)}</p>
            </div>
          ` : ''}

          ${this.user.specialties && this.user.specialties.length > 0 ? `
            <div class="info-section">
              <h3>Specialties</h3>
              <div class="specialties-list">
                ${this.user.specialties.map(s => `<span class="specialty-tag">${this.escapeHtml(s)}</span>`).join('')}
              </div>
            </div>
          ` : ''}
        ` : ''}
      `;

      document.getElementById('profile-info').innerHTML = infoHtml;
    }

    /**renderMenu() {
      const menuHtml = `
        <div class="menu-item" id="role-switch-item">
          <i class="fas fa-sync-alt"></i>
          <span>Switch to ${this.user.role === 'artisan' ? 'Client' : 'Artisan'} Mode</span>
          <label class="toggle-container">
            <input type="checkbox" id="role-toggle" ${this.user.role === 'artisan' ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </div>

        <a href="bookings.html" class="menu-item">
          <i class="fas fa-calendar"></i>
          <span>My Bookings</span>
          <i class="fas fa-chevron-right"></i>
        </a>

        <a href="favorites.html" class="menu-item">
          <i class="fas fa-heart"></i>
          <span>Favorites</span>
          <i class="fas fa-chevron-right"></i>
        </a>

        ${this.user.role === 'artisan' ? `
          <a href="clients.html" class="menu-item">
            <i class="fas fa-users"></i>
            <span>My Clients</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        ` : ''}

        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
          <i class="fas fa-chevron-right"></i>
        </a>

        <div class="menu-item" id="toggle-theme">
          <i class="fas fa-moon"></i>
          <span>Dark Mode</span>
          <i class="fas fa-chevron-right"></i>
        </div>
      `;

      document.getElementById('profile-menu').innerHTML = menuHtml;
    }**/
    renderMenu() {
    const currentTheme = this.themeManager.getCurrentTheme();
    const isDark = currentTheme === 'dark';
    
    const menuHtml = `
      <div class="menu-item" id="role-switch-item">
        <i class="fas fa-sync-alt"></i>
        <span>Switch to ${this.user.role === 'artisan' ? 'Client' : 'Artisan'} Mode</span>
        <label class="toggle-container">
          <input type="checkbox" id="role-toggle" ${this.user.role === 'artisan' ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <a href="bookings.html" class="menu-item">
        <i class="fas fa-calendar"></i>
        <span>My Bookings</span>
        <i class="fas fa-chevron-right"></i>
      </a>

      <a href="favorites.html" class="menu-item">
        <i class="fas fa-heart"></i>
        <span>Favorites</span>
        <i class="fas fa-chevron-right"></i>
      </a>

      ${this.user.role === 'artisan' ? `
        <a href="clients.html" class="menu-item">
          <i class="fas fa-users"></i>
          <span>My Clients</span>
          <i class="fas fa-chevron-right"></i>
        </a>
      ` : ''}

      <a href="settings.html" class="menu-item">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
        <i class="fas fa-chevron-right"></i>
      </a>

      <div style="display: none" class="menu-item" id="toggle-theme">
        <i class="fas ${isDark ? 'fa-sun' : 'fa-moon'}"></i>
        <span>${isDark ? 'Light' : 'Dark'} Mode</span>
        <label class="toggle-container">
          <input type="checkbox" id="theme-toggle" ${isDark ? 'checked' : ''}>
          <span class="toggle-slider"></span>
        </label>
      </div>
    `;

    document.getElementById('profile-menu').innerHTML = menuHtml;
  }

    renderActions() {
      const actionsHtml = `
        <button id="logout-btn" class="btn-danger" style="display: none">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      `;

      document.getElementById('profile-actions').innerHTML = actionsHtml;
    }

    bindEvents() {
    // Back button
    document.getElementById('back-btn')?.addEventListener('click', () => {
      window.history.back();
    });

    // Edit button
    document.getElementById('edit-profile-btn')?.addEventListener('click', () => {
      this.openEditModal();
    });

    // Logout button
    document.getElementById('logout-btn')?.addEventListener('click', () => {
      console.log("Logout button clicked");
      this.handleLogout();
    });

    // Role switch
    const roleToggle = document.querySelector('#role-toggle');
    const roleSwitchItem = document.querySelector('#role-switch-item');
    
    if (roleToggle && roleSwitchItem) {
      const handleRoleSwitch = async () => {
        const newRole = roleToggle.checked ? 'artisan' : 'client';
        
        if (this.user.role === newRole) {
          return;
        }
        
        console.log('Switching role from', this.user.role, 'to', newRole);
        
        try {
          roleToggle.disabled = true;
          roleSwitchItem.style.opacity = '0.6';
          
          const updatedUser = await API.switchUserRole(this.user.id, newRole);
          
          console.log('Role switched successfully:', updatedUser);
          
          localStorage.setItem('userData', JSON.stringify(updatedUser));
          this.user = updatedUser;
          
          this.showToast(`Switched to ${newRole} mode`, 'success');
          
          setTimeout(() => {
            window.location.reload();
          }, 1000);
          
        } catch (error) {
          console.error('Role switch failed:', error);
          this.showToast(`Failed to switch role: ${error.message}`, 'error');
          
          roleToggle.checked = this.user.role === 'artisan';
          roleToggle.disabled = false;
          roleSwitchItem.style.opacity = '1';
        }
      };

      roleToggle.addEventListener('change', handleRoleSwitch);
      
      roleSwitchItem.addEventListener('click', (e) => {
        if (e.target !== roleToggle && !e.target.closest('.toggle-slider')) {
          roleToggle.checked = !roleToggle.checked;
          roleToggle.dispatchEvent(new Event('change'));
        }
      });
    }

      // Theme toggle
      const themeToggle = document.querySelector('#theme-toggle');
    const themeToggleItem = document.querySelector('#toggle-theme');
    
    if (themeToggle && themeToggleItem) {
      const handleThemeSwitch = () => {
        const newTheme = this.themeManager.toggleTheme();
        
        // Update UI
        const icon = themeToggleItem.querySelector('i');
        const label = themeToggleItem.querySelector('span');
        
        if (newTheme === 'dark') {
          icon.className = 'fas fa-sun';
          label.textContent = 'Light Mode';
        } else {
          icon.className = 'fas fa-moon';
          label.textContent = 'Dark Mode';
        }
        
        this.showToast(`Switched to ${newTheme} mode`, 'success');
      };

      // Toggle checkbox listener
      themeToggle.addEventListener('change', handleThemeSwitch);
      
      // Make entire row clickable
      themeToggleItem.addEventListener('click', (e) => {
        if (e.target !== themeToggle && !e.target.closest('.toggle-slider')) {
          themeToggle.checked = !themeToggle.checked;
          themeToggle.dispatchEvent(new Event('change'));
        }
      });
    }

    // Listen for theme changes from other tabs
    window.addEventListener('themechange', (e) => {
      console.log('Theme changed in another tab:', e.detail.theme);
      this.renderMenu(); // Re-render menu to update toggle state
    });
  } 

    openEditModal() {
      const modal = document.getElementById('edit-modal');
      const form = document.getElementById('edit-profile-form');

      const isVerified = this.user.verified || false;

      form.innerHTML = `
        <!-- Profile Picture -->
        <div class="form-group profile-pic-group">
          <label>Profile Picture</label>
          <div class="pic-upload-container">
            <img id="preview-avatar" src="${this.getAvatarUrl(this.user)}" alt="Preview" class="pic-preview">
            <label for="avatar-upload" class="upload-label">
              <i class="fas fa-camera"></i>
              <span>Change Photo</span>
            </label>
            <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
          </div>
        </div>

        <!-- Basic Info -->
        <div class="form-group">
          <label for="edit-name">Full Name ${isVerified ? '<span style="color: var(--muted); font-weight: normal;">(Verified - Cannot Edit)</span>' : '*'}</label>
          <input type="text" id="edit-name" value="${this.escapeHtml(this.user.name || '')}" ${isVerified ? 'disabled' : 'required'} style="${isVerified ? 'background: var(--border); color: var(--muted);' : ''}">
        </div>

        <div class="form-group">
          <label for="edit-email">Email ${isVerified ? '<span style="color: var(--muted); font-weight: normal;">(Verified - Cannot Edit)</span>' : '*'}</label>
          <input type="email" id="edit-email" value="${this.escapeHtml(this.user.email || '')}" ${isVerified ? 'disabled' : 'required'} style="${isVerified ? 'background: var(--border); color: var(--muted);' : ''}">
        </div>

        <div class="form-group">
          <label for="edit-phone">Phone (WhatsApp)</label>
          <input type="tel" id="edit-phone" value="${this.escapeHtml(this.user.phone || '')}" placeholder="08012345678">
        </div>

        <div class="form-group">
          <label for="edit-location">Location *</label>
          <input type="text" id="edit-location" value="${this.escapeHtml(this.user.location || '')}" required>
        </div>

        ${this.user.role === 'artisan' ? `
          <!-- Artisan Fields -->
          <div class="form-group">
            <label for="edit-skill">Skill/Service *</label>
            <input type="text" id="edit-skill" value="${this.escapeHtml(this.user.skill || '')}" required>
          </div>

          <div class="form-group">
            <label for="edit-experience">Years of Experience *</label>
            <input type="number" id="edit-experience" value="${this.user.years_experience || 0}" min="0" required>
          </div>

          <div class="form-group">
            <label for="edit-rate">Service Rate (â‚¦)</label>
            <input type="number" id="edit-rate" value="${this.user.rate || 0}" min="0" step="500">
          </div>

          <div class="form-group">
            <label for="edit-about">About *</label>
            <textarea id="edit-about" rows="4" required>${this.escapeHtml(this.user.about || '')}</textarea>
          </div>

          <div class="form-group">
            <label for="edit-specialties">Specialties (comma-separated)</label>
            <input type="text" id="edit-specialties" value="${(this.user.specialties || []).join(', ')}">
          </div>
        ` : ''}

        <div class="form-actions">
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button type="button" class="btn-secondary cancel-btn">Cancel</button>
        </div>
      `;

      // Show modal
      modal.classList.remove('hidden');

      // Bind modal events
      this.bindModalEvents(modal, form);
    }

    bindModalEvents(modal, form) {
      // Avatar preview
      const avatarInput = document.getElementById('avatar-upload');
      const previewImg = document.getElementById('preview-avatar');

      avatarInput?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          // Validate file size (5MB max)
          if (file.size > 5 * 1024 * 1024) {
            this.showToast('Image must be less than 5MB', 'error');
            avatarInput.value = '';
            return;
          }

          const reader = new FileReader();
          reader.onload = (event) => {
            previewImg.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await this.handleProfileUpdate(form);
      });

      // Close modal
      modal.querySelector('.modal-close')?.addEventListener('click', () => {
        modal.classList.add('hidden');
      });

      modal.querySelector('.cancel-btn')?.addEventListener('click', () => {
        modal.classList.add('hidden');
      });
    }

    async handleProfileUpdate(form) {
      try {
        const isVerified = this.user.verified || false;
        const updates = {
          phone: document.getElementById('edit-phone').value,
          location: document.getElementById('edit-location').value
        };

        // Only add name and email if not verified
        if (!isVerified) {
          updates.name = document.getElementById('edit-name').value;
          updates.email = document.getElementById('edit-email').value;
        }

        // Add artisan-specific fields
        if (this.user.role === 'artisan') {
          updates.skill = document.getElementById('edit-skill').value;
          updates.years_experience = parseInt(document.getElementById('edit-experience').value) || 0;
          updates.rate = parseInt(document.getElementById('edit-rate').value) || 0;
          updates.about = document.getElementById('edit-about').value;
          
          const specialties = document.getElementById('edit-specialties').value
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
          updates.specialties = specialties;
        }

        console.log('Updating profile with:', updates);

        // Update via API
        const updatedUser = await API.updateUserProfile(this.user.id, updates);
        
        console.log('Profile updated successfully:', updatedUser);
        
        this.user = updatedUser;
        localStorage.setItem('userData', JSON.stringify(updatedUser));

        // Handle avatar upload if selected
        const avatarFile = document.getElementById('avatar-upload').files[0];
        if (avatarFile) {
          try {
            this.showToast('Uploading avatar...', 'info');
            const avatarUser = await API.uploadProfileImage(this.user.id, avatarFile);
            this.user = avatarUser;
            localStorage.setItem('userData', JSON.stringify(avatarUser));
          } catch (error) {
            console.error('Avatar upload failed:', error);
            this.showToast('Profile updated but avatar upload failed', 'error');
          }
        }

        // Close modal and refresh
        document.getElementById('edit-modal').classList.add('hidden');
        await this.renderProfile();
        
        this.showToast('Profile updated successfully!', 'success');

      } catch (error) {
        console.error('Profile update failed:', error);
        this.showToast(`Failed to update profile: ${error.message}`, 'error');
      }
    }

    // CORRECT LOGOUT IMPLEMENTATION
    /** handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        console.log('Logging out...');
        
        // Use your actual logout function from api.js
        API.logout();
        
        // Redirect to home page
        window.location.href = 'index.html';
      }
    } **/
    
    handleLogout() {
  // Create custom logout modal
  const modalHtml = `
    <div id="logout-modal" style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    ">
      <div style="
        background: var(--card);
        padding: 30px;
        border-radius: 16px;
        max-width: 400px;
        width: 90%;
        text-align: center;
      ">
        <i class="fas fa-sign-out-alt" style="
          font-size: 48px;
          color: var(--green);
          margin-bottom: 20px;
        "></i>
        <h3 style="margin-bottom: 10px;">Logout</h3>
        <p style="color: var(--muted); margin-bottom: 30px;">
          Are you sure you want to logout?
        </p>
        <div style="display: flex; gap: 12px;">
          <button id="confirm-logout" style="
            flex: 1;
            padding: 12px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">
            Yes, Logout
          </button>
          <button id="cancel-logout" style="
            flex: 1;
            padding: 12px;
            background: var(--border);
            color: var(--text);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
          ">
            Cancel
          </button>
        </div>
      </div>
    </div>
  `;

  // Insert modal
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  const modal = document.getElementById('logout-modal');
  const confirmBtn = document.getElementById('confirm-logout');
  const cancelBtn = document.getElementById('cancel-logout');

  // Confirm logout
  confirmBtn.addEventListener('click', () => {
    console.log('Logging out...');
    
    // Remove modal
    modal.remove();
    
    // Perform logout
    try {
      API.logout();
      
      // Show brief loading message
      document.body.insertAdjacentHTML('beforeend', `
        <div style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: var(--card);
          padding: 30px;
          border-radius: 16px;
          text-align: center;
          z-index: 10001;
        ">
          <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--green);"></i>
          <p style="margin-top: 16px;">Logging out...</p>
        </div>
      `);
      
      // Redirect after brief delay
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 500);
      
    } catch (error) {
      console.error('Logout failed:', error);
      alert('Logout failed. Please try again.');
    }
  });

  // Cancel logout
  cancelBtn.addEventListener('click', () => {
    modal.remove();
  });

  // Click outside to cancel (this won't freeze!)
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

    escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card);
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        z-index: 2000;
        border-left: 4px solid ${type === 'success' ? 'var(--green)' : type === 'error' ? '#dc2626' : 'var(--border)'};
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    showError(message) {
      document.querySelector('.profile-content').innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>${message}</p>
          <button onclick="location.reload()">Retry</button>
        </div>
      `;
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    new ProfilePage();
  });
</script>
</body>
</html>